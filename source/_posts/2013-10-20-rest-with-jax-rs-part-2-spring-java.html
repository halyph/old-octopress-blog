---
layout: post
title: 'REST with JAX-RS: Part 2 - Spring Java Config and CXF Improvement'
date: '2013-10-20T10:00:00.000+03:00'
author: Orest Ivasiv
categories:
- java
- rest
- jax-rs
- spring
- cxf
modified_time: '2013-10-21T22:54:34.277+03:00'
thumbnail: http://1.bp.blogspot.com/-KC2gFdfkvnE/Ul8JQLUCq9I/AAAAAAAABs0/IhySnzRFWd4/s72-c/rest_logo_small.png
blogger_id: tag:blogger.com,1999:blog-7372777165432727866.post-4129081347179810651
blogger_orig_url: http://www.halyph.com/2013/10/rest-with-jax-rs-part-2-spring-java.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-KC2gFdfkvnE/Ul8JQLUCq9I/AAAAAAAABs0/IhySnzRFWd4/s1600/rest_logo_small.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-KC2gFdfkvnE/Ul8JQLUCq9I/AAAAAAAABs0/IhySnzRFWd4/s1600/rest_logo_small.png" /></a></div><br />See previous post:<br /><ul><li><a href="http://www.halyph.com/2013/10/rest-with-jax-rs-part-1-spring-java.html">REST with JAX-RS: Part 1 - Spring Java Config</a>&nbsp; </li></ul>Sample application from part 1 has several issues:<br /><ol><li>It doesn't have application wide REST exception handler. This handler should catch and wrap all internal exceptions and present in some "standard" JSON format</li><li>There are no autowiring for REST Resources and JAX-RS providers. I.e. we shouldn't declare REST service beans/providers manually in AppConfig (see <a href="http://www.halyph.com/2013/10/rest-with-jax-rs-part-1-spring-java.html">part1</a>)</li><li>CXF object mapper (Jackson) should be configured and registered in CXF somehow</li></ol>Let's try to fix all these issues.<br /><br />JAX-RS has special approach for exception handling - <a href="http://cxf.apache.org/docs/jax-rs-basics.html#JAX-RSBasics-Exceptionhandling">ExceptionMapper</a>.<br />Let's define two mappers:<br /><ul><li><b>GeneralExceptionMapper</b> - will catch and handle all <b>Exceptions</b></li><li><b>NotFoundExceptionMapper</b> - will catch and handle only <b>NotFoundException</b></li></ul><pre class="brush: java;"> <br />package com.halyph.rest.provider;<br /><br />import javax.ws.rs.NotFoundException;<br />import javax.ws.rs.Produces;<br />import javax.ws.rs.core.MediaType;<br />import javax.ws.rs.core.Response;<br />import javax.ws.rs.ext.ExceptionMapper;<br />import javax.ws.rs.ext.Provider;<br />import java.util.Date;<br />import java.util.HashMap;<br />import java.util.Map;<br /><br />@Provider<br />@Produces(MediaType.APPLICATION_JSON)<br />public class NotFoundExceptionMapper implements ExceptionMapper&lt;NotFoundException&gt; {<br />    /**<br />     * Map an exception to a {@link javax.ws.rs.core.Response}.<br />     *<br />     * @param exception the exception to map to a response.<br />     * @return a response mapped from the supplied exception.<br />     */<br />    @Override<br />    public Response toResponse(final NotFoundException exception) {<br />        Map&lt;String, Object&gt; info = new HashMap&lt;&gt;();<br />        info.put("msg", exception.getMessage());<br />        info.put("date", new Date());<br />        info.put("details", "The requested resource hasn't been found");<br /><br />        return Response<br />                .status(Response.Status.INTERNAL_SERVER_ERROR)<br />                .entity(info)<br />                .type(MediaType.APPLICATION_JSON)<br />                .build();<br />    }<br />}<br /></pre><pre class="brush: java;"> <br />package com.halyph.rest.provider;<br /><br />import javax.ws.rs.Produces;<br />import javax.ws.rs.core.MediaType;<br />import javax.ws.rs.core.Response;<br />import javax.ws.rs.ext.ExceptionMapper;<br />import javax.ws.rs.ext.Provider;<br />import java.util.Date;<br />import java.util.HashMap;<br />import java.util.Map;<br /><br />@Provider<br />@Produces(MediaType.APPLICATION_JSON)<br />public class GeneralExceptionMapper implements ExceptionMapper&lt;exception&gt; {<br />    /**<br />     * Map an exception to a {@link javax.ws.rs.core.Response}.<br />     *<br />     * @param exception the exception to map to a response.<br />     * @return a response mapped from the supplied exception.<br />     */<br />    @Override<br />    public Response toResponse(final Exception exception) {<br />        Map&lt;String, Object&gt; info = new HashMap&lt;&gt;();<br />        info.put("msg", exception.getMessage());<br />        info.put("date", new Date());<br /><br />        return Response<br />                .status(Response.Status.INTERNAL_SERVER_ERROR)<br />                .entity(info)<br />                .type(MediaType.APPLICATION_JSON)<br />                .build();<br />    }<br />}<br /></pre><br />And, modify <b>UserResource</b> which throws <b>NotFoundException</b> when some user can't be found by specified id <br /><pre class="brush: java;"> <br />@RestService<br />@Path("/users")<br />@Produces({MediaType.APPLICATION_JSON})<br />@Consumes({MediaType.APPLICATION_JSON})<br />public class UserResource {<br /><br /> ...<br />    @GET<br />    @Path("/{id}")<br />    public User getUser(@PathParam("id") Integer id) {<br />        User user = service.getUser(id);<br />        if (user == null) {<br />            throw new NotFoundException();<br />        } else {<br />            return user;<br />        }<br />    }<br /><br />    ...<br />}<br /></pre><br />Now, we have to implement REST resource/provider autowiring. 1st we create custom @RestService annotation.<br /><pre class="brush: java;"> <br />package com.halyph.util.annotation;<br /><br />import java.lang.annotation.Documented;<br />import java.lang.annotation.ElementType;<br />import java.lang.annotation.Retention;<br />import java.lang.annotation.RetentionPolicy;<br />import java.lang.annotation.Target;<br /><br />@Retention(RetentionPolicy.RUNTIME)<br />@Target(ElementType.TYPE)<br />@Documented<br />public @interface RestService {<br />}<br /></pre><br />Now we have to implement Spring bean scanners which scan specified package and register "selected" beans in Spring context.<br /><br /><pre class="brush: java;"> <br />package com.halyph.util;<br /><br />import org.springframework.context.ApplicationContext;<br />import org.springframework.context.annotation.ClassPathBeanDefinitionScanner;<br />import org.springframework.context.support.GenericApplicationContext;<br />import org.springframework.core.type.filter.AnnotationTypeFilter;<br /><br />import javax.ws.rs.ext.Provider;<br />import java.util.ArrayList;<br />import java.util.List;<br /><br />public final class RestProviderBeanScanner {<br /><br />    private RestProviderBeanScanner() { }<br />    public static List&lt;Object&gt; scan(ApplicationContext applicationContext, String... basePackages) {<br />        GenericApplicationContext genericAppContext = new GenericApplicationContext();<br />        ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(genericAppContext, false);<br /><br />        scanner.addIncludeFilter(new AnnotationTypeFilter(Provider.class));<br />        scanner.scan(basePackages);<br />        genericAppContext.setParent(applicationContext);<br />        genericAppContext.refresh();<br /><br />        return new ArrayList&lt;&gt;(genericAppContext.getBeansWithAnnotation(Provider.class).values());<br />    }<br />}<br /></pre><pre class="brush: java;"> <br />package com.halyph.util;<br /><br />import com.halyph.util.annotation.RestService;<br />import org.springframework.context.ApplicationContext;<br />import org.springframework.context.annotation.ClassPathBeanDefinitionScanner;<br />import org.springframework.context.support.GenericApplicationContext;<br />import org.springframework.core.type.filter.AnnotationTypeFilter;<br /><br />import java.util.ArrayList;<br />import java.util.List;<br /><br />public final class RestServiceBeanScanner {<br /><br />    private RestServiceBeanScanner() { }<br /><br />    public static List&lt;Object&gt; scan(ApplicationContext applicationContext, String... basePackages) {<br />        GenericApplicationContext genericAppContext = new GenericApplicationContext();<br />        ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(genericAppContext, false);<br /><br />        scanner.addIncludeFilter(new AnnotationTypeFilter(RestService.class));<br />        scanner.scan(basePackages);<br />        genericAppContext.setParent(applicationContext);<br />        genericAppContext.refresh();<br /><br />        List&lt;Object&gt; restResources = new ArrayList&lt;&gt;(genericAppContext.getBeansWithAnnotation(RestService.class).values());<br /><br />        return restResources;<br />    }<br />}</pre>These two classes (scanner) <b>RestServiceBeanScanner</b> and <b>RestProviderBeanScanner</b> are almost identical and should be refactored to support generic scanner type. Let's left this for home work. <br /><br />There is additional issue with missed Object Mapper configuration: <br /><pre class="brush: java;"> <br />package com.halyph.rest.provider;<br /><br />import com.fasterxml.jackson.databind.ObjectMapper;<br />import com.fasterxml.jackson.databind.SerializationFeature;<br /><br />import javax.ws.rs.ext.ContextResolver;<br />import javax.ws.rs.ext.Provider;<br />import java.text.DateFormat;<br />import java.text.SimpleDateFormat;<br />import java.util.TimeZone;<br /><br />@Provider<br />public class ObjectMapperProvider implements ContextResolver&lt;Objectmapper&gt; {<br /><br />    final ObjectMapper objectMapper;<br /><br />    public ObjectMapperProvider() {<br />        this.objectMapper = new ObjectMapper();<br />        this.objectMapper.configure(SerializationFeature.INDENT_OUTPUT, true);<br /><br />        //set up ISO 8601 date/time stamp format:<br />        final DateFormat df = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:sss'Z'");<br />        df.setTimeZone(TimeZone.getTimeZone("UTC"));<br />        this.objectMapper.setDateFormat(df);<br />    }<br /><br />    @Override<br />    public ObjectMapper getContext(Class type) {<br />        return this.objectMapper;<br />    }<br />}<br /></pre><br />We have to update AppConfig:<br /><ul><li>&nbsp;Add <b>@ComponentScan</b> to register services</li><li>Call <b>RestProviderBeanScanner </b>to register providers: json provider, <i>ExceptionMapper</i> and&nbsp; ObjectMapperProvider</li><li>Call <b>RestServiceBeanScanner </b>to register REST services marked with <b>@RestService</b> annotation</li></ul><pre class="brush: java;"> <br />package com.halyph.config;<br /><br />import com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider;<br />import com.halyph.util.RestProviderBeanScanner;<br />import com.halyph.util.RestServiceBeanScanner;<br />import org.apache.cxf.bus.spring.SpringBus;<br />import org.apache.cxf.endpoint.Server;<br />import org.apache.cxf.jaxrs.JAXRSServerFactoryBean;<br />import org.springframework.context.ApplicationContext;<br />import org.springframework.context.annotation.Bean;<br />import org.springframework.context.annotation.ComponentScan;<br />import org.springframework.context.annotation.Configuration;<br />import org.springframework.context.annotation.DependsOn;<br /><br />import javax.ws.rs.ApplicationPath;<br />import javax.ws.rs.core.Application;<br />import javax.ws.rs.ext.RuntimeDelegate;<br />import java.util.List;<br /><br />@Configuration<br />@ComponentScan(AppConfig.SERVICE_PACKAGE)<br />public class AppConfig {<br /><br />    public static final String BASE_PACKAGE = "com.halyph";<br />    public static final String SERVICE_PACKAGE = BASE_PACKAGE + ".service";<br />    private static final String RESOURCES_PACKAGE = BASE_PACKAGE + ".rest";<br />    private static final String PROVIDER_PACKAGE = BASE_PACKAGE + ".rest.provider";<br /><br />    @ApplicationPath("/")<br />    public class JaxRsApiApplication extends Application { }<br /><br />    @Bean(destroyMethod = "shutdown")<br />    public SpringBus cxf() {<br />        return new SpringBus();<br />    }<br /><br />    @Bean<br />    @DependsOn("cxf")<br />    public Server jaxRsServer(ApplicationContext appContext) {<br />        JAXRSServerFactoryBean factory = RuntimeDelegate.getInstance().createEndpoint(jaxRsApiApplication(), JAXRSServerFactoryBean.class);<br />        factory.setServiceBeans(restServiceList(appContext));<br />        factory.setAddress("/" + factory.getAddress());<br />        factory.setProviders(restProviderList(appContext, jsonProvider()));<br />        return factory.create();<br />    }<br /><br />    @Bean<br />    public JaxRsApiApplication jaxRsApiApplication() {<br />        return new JaxRsApiApplication();<br />    }<br /><br />    @Bean<br />    public JacksonJsonProvider jsonProvider() {<br />        return new JacksonJsonProvider();<br />    }<br /><br />    private List&lt;Object&gt; restServiceList(ApplicationContext appContext) {<br />        return RestServiceBeanScanner.scan(appContext, AppConfig.RESOURCES_PACKAGE);<br />    }<br /><br />    private List&lt;Object&gt; restProviderList(final ApplicationContext appContext,<br />                                          final JacksonJsonProvider jsonProvider) {<br />        final List&lt;Object&gt; providers = RestProviderBeanScanner.scan(appContext, PROVIDER_PACKAGE);<br />        providers.add(jsonProvider);<br />        return providers;<br />    }<br /><br />}<br /></pre><br />Now, we should test this. 1st run application:<br /><pre class="brush: bash;">mvn clean tomcat7:run</pre><br />Verify REST API calls: <br /><pre class="brush: bash;"># pretty printed JSON, see ObjectMapperProvider <br />$  curl http://localhost:8080/api/users<br />[ {<br />  "id" : 1,<br />  "name" : "foo"<br />}, {<br />  "id" : 2,<br />  "name" : "bar"<br />}, {<br />  "id" : 3,<br />  "name" : "baz"<br />} ]<br /><br /># try to get non-existent user, expected to get NotFoundException JSON<br />$ curl http://localhost:8080/api/users/100<br />{<br />  "details" : "The requested resource hasn't been found",<br />  "date" : "2013-10-19T13:39:034Z",<br />  "msg" : null<br />}<br /><br /># try to get GeneralException JSON<br />$  curl http://localhost:8080/api/exception<br />{<br />  "date" : "2013-10-19T13:40:049Z",<br />  "msg" : "generateException from ExceptionResource"<br />}<br /></pre><br /><img border="0" src="http://4.bp.blogspot.com/-19PdlvA340g/UmJjzXEXT6I/AAAAAAAABtM/hu7TPhIwD0U/s1600/Logos-Github-icon.png" />&nbsp;&nbsp; You can find sources on <a href="https://github.com/halyph/jaxrs-tutorials/tree/part/02-spring-java-config-improved">GitHub</a><br /><br /><b>References</b><br /><ol><li><a href="http://www.luckyryan.com/2013/06/15/apache-cxf-exception-handler-for-jaxrs-rest/">Apache CXF exception handler for jaxrs (REST) </a></li><li><a href="http://cxf.apache.org/docs/jax-rs-basics.html#JAX-RSBasics-Exceptionhandling">Official documentation: Apache CXF Exception handling</a><b><br /></b></li></ol>