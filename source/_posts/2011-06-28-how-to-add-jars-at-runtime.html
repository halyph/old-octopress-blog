---
layout: post
title: How to Add Jars at Runtime?
date: '2011-06-28T14:34:00.000+03:00'
author: Orest Ivasiv
tags:
- java
modified_time: '2011-06-28T14:34:54.522+03:00'
thumbnail: http://1.bp.blogspot.com/-QtlWo-1EDkg/TgmwZRBlMUI/AAAAAAAAAdE/10zbvjjHeTE/s72-c/img1.png
blogger_id: tag:blogger.com,1999:blog-7372777165432727866.post-515592781437808025
blogger_orig_url: http://www.halyph.com/2011/06/how-to-add-jars-at-runtime.html
---

Suppose you have the next project structure:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-QtlWo-1EDkg/TgmwZRBlMUI/AAAAAAAAAdE/10zbvjjHeTE/s1600/img1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-QtlWo-1EDkg/TgmwZRBlMUI/AAAAAAAAAdE/10zbvjjHeTE/s1600/img1.png" /></a></div><br />Here is the source code:<br /><br /><pre class="brush: java;">package org.halyph.one;<br /><br />import java.io.File;<br />import java.lang.reflect.InvocationTargetException;<br />import java.lang.reflect.Method;<br />import java.net.MalformedURLException;<br />import java.net.URL;<br />import java.net.URLClassLoader;<br />import java.security.CodeSource;<br /><br />import org.halyph.three.MyClassThree;<br />import org.halyph.two.MyClassTwo;<br /><br />public class DynamicClassLoader {<br /> public static void main(String[] args) throws Exception {<br />  System.out.println("DynamicClassLoader.main()");<br /><br />  MyClassTwo myClassTwo = new MyClassTwo();<br />  MyClassThree myClassThree = new MyClassThree();<br />  myClassTwo.printMessage();<br />  myClassThree.printMessage();<br /><br /> }<br />}<br /><br />package org.halyph.two;<br /><br />public class MyClassTwo {<br /> public void printMessage() {<br />  System.out.println("MyClassTwo.printMessage()");<br /> }<br />}<br /><br />package org.halyph.three;<br /><br />public class MyClassThree {<br /> public void printMessage() {<br />  System.out.println("MyClassThree.printMessage()");<br /> }<br />}<br /><br /></pre>And each of these classes are packed in separate jar:<br /><ul><li>org.halyph.one.DynamicClassLoader - dynone.jar</li><li>org.halyph.two.MyClassTwo - dyntwo.jar</li><li>org.halyph.three.MyClassThree - dynthree.jar</li></ul>To run this application you should put all these jars on classpath,<br />E.g. the application output<br /><pre class="brush: bash;"># java -cp dynone.jar;dyntwo.jar;dynthree.jar org.halyph.one.DynamicClassLoader<br />DynamicClassLoader.main()<br />MyClassTwo.printMessage()<br />MyClassThree.printMessage()<br /></pre><br />But there are some cases when <b>dyntwo.jar</b> and <b>dynthree.jar</b> jars location can be known during runtime only. And we have to run our application in the next way:<br /><pre class="brush: bash;"># java -cp dynone.jar org.halyph.one.DynamicClassLoader<br /></pre><br />Of cause, you'll get the next (or similar) error:<br /><pre class="brush: bash;"># java -cp dynone.jar org.halyph.one.DynamicClassLoader<br />DynamicClassLoader.main()<br />Exception in thread "main" java.lang.NoClassDefFoundError: org/halyph/two/MyClassTwo<br />        at org.halyph.one.DynamicClassLoader.main(DynamicClassLoader.java:28)<br />Caused by: java.lang.ClassNotFoundException: org.halyph.two.MyClassTwo<br />        at java.net.URLClassLoader$1.run(Unknown Source)<br />        at java.security.AccessController.doPrivileged(Native Method)<br />        at java.net.URLClassLoader.findClass(Unknown Source)<br />        at java.lang.ClassLoader.loadClass(Unknown Source)<br />        at sun.misc.Launcher$AppClassLoader.loadClass(Unknown Source)<br />        at java.lang.ClassLoader.loadClass(Unknown Source)<br />        ... 1 more<br /></pre><br />So, how can we solve this problem?<br />Here is the patched org.halyph.one.DynamicClassLoader:<br /><pre class="brush: java;">package org.halyph.one;<br /><br />import java.io.File;<br />import java.lang.reflect.InvocationTargetException;<br />import java.lang.reflect.Method;<br />import java.net.MalformedURLException;<br />import java.net.URL;<br />import java.net.URLClassLoader;<br />import java.security.CodeSource;<br /><br />import org.halyph.three.MyClassThree;<br />import org.halyph.two.MyClassTwo;<br /><br />public class DynamicClassLoader {<br /><br /> public static void main(String[] args) throws Exception {<br />  System.out.println("DynamicClassLoader.main()");<br /><br />  String[] jars = new String[] { "dyntwo.jar",  "dynthree.jar"};<br />  addJarsToClasspath(getRootFolder(), jars);<br />  MyClassTwo myClassTwo = new MyClassTwo();<br />  MyClassThree myClassThree = new MyClassThree();<br />  myClassTwo.printMessage();<br />  myClassThree.printMessage();<br /><br /> }<br /><br /> public static void addJarsToClasspath(String rootFolder, String[] jarNames)<br />   throws SecurityException, NoSuchMethodException,<br />   MalformedURLException, IllegalArgumentException,<br />   IllegalAccessException, InvocationTargetException {<br /><br />  Method addURL = URLClassLoader.class.getDeclaredMethod("addURL",<br />    new Class[] { URL.class });<br />  addURL.setAccessible(true); // you're telling the JVM to override the<br />         // default visibility<br /><br />  File[] files = new File[jarNames.length];<br />  int i = 0;<br />  for (String jarName : jarNames) {<br />   files[i++] = new File(rootFolder + jarName);<br />  }<br /><br />  // returning the jars to add<br />  ClassLoader cl = ClassLoader.getSystemClassLoader();<br />  for (i = 0; i &lt; files.length; i++) {<br />   URL url = files[i].toURL();<br />   addURL.invoke(cl, new Object[] { url });<br />  }<br /> }<br /><br /> public static String getRootFolder() {<br />  String result = null;<br />  try {<br />   String qualifiedClassName = DynamicClassLoader.class.getName();<br /><br />   Class qc = Class.forName(qualifiedClassName);<br />   CodeSource source = qc.getProtectionDomain().getCodeSource();<br />   if (source != null) {<br />    URL location = source.getLocation();<br />    File file = new File(location.toURI());<br /><br />    result = file.getParent() + "/";<br />   } else {<br />    System.out.println(qualifiedClassName + " : "<br />      + "unknown source");<br />   }<br />  } catch (Exception e) {<br />   System.err.println("Unable to locate class on command line.");<br />   e.printStackTrace();<br />  }<br />  return result;<br /> }<br /><br />}<br /></pre><br />Here is the output of patched application:<br /><br /><pre class="brush: bash;"># java -cp dynone.jar org.halyph.one.DynamicClassLoader<br />DynamicClassLoader.main()<br />MyClassTwo.printMessage()<br />MyClassThree.printMessage()<br /></pre><br />So, two additional methods were added to support this "magic":<br /><ul><li><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">public static String getRootFolder()</span>- this method simply identifies the folder where dynone.jar (on behalf of <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">org.halyph.one.DynamicClassLoader</span> class) is located. Because for this demo we put all application-related jars in one folder</li><li><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">public static void addJarsToClasspath(String rootFolder, String[] jarNames)</span> - and here the "magic" happen. Based on this post on <a href="http://www.velocityreviews.com/forums/t148021-dynamically-change-the-classpath.html">www.velocityreviews.com forums</a>:</li></ul><blockquote>There is a well-known hack for dynamically extending the class path.<br />It generally works, and we use it in production releases of our software. It uses reflection, plus the knowledge that the default ClassLoader *is* a URLClassLoader.<br />...<br />As I said, this is a hack, <b>undocumented</b>, and subject to change at any<br />time. Indeed, there's no guarantee that extant JREs use a URLClassLoader as a default class loader. Moreover, it only works if your program doesn't have a security manager (it probably doesn't), or your code is trusted.<br />...<br />We've never seen problems with it, although our software is used on a plethora of different boxes and OSs.</blockquote>It works for me and I hope it will be useful for you as well.<br />Happy hacking!