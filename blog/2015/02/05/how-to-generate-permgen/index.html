
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How to Generate PermGen Leak? - Knowledge Is Everything</title>
  <meta name="author" content="Orest Ivasiv">

  
  <meta name="description" content="I&rsquo;m sure that a lot of Java developers experienced java.lang.OutOfMemoryError: PermGen space (OOME PermGen). It was very common to get this &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://halyph.com/blog/2015/02/05/how-to-generate-permgen">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Knowledge Is Everything" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-54626671-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <!-- <header role="banner"><hgroup>
  <h1><a href="/">Knowledge Is Everything</a></h1>
  
</hgroup>

</header> -->
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:halyph.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/">
        <span class="blue_light">
            Knowledge Is Everything
        </span>
       
    </a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About me</a></li>
  <li><a href="http://halyph.blogspot.com">Old Blog</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How to Generate PermGen Leak?</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-05T00:05:30+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:05 am</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://halyph.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><img class="center" src="/images/blog/java.png"></p>

<p>I&rsquo;m sure that a lot of Java developers experienced <code>java.lang.OutOfMemoryError: PermGen space</code> (OOME PermGen). It was very common to get this error after multiple WAR re-deploys on Tomcat v.6.x. Permanent generation (PermGen) region of memory is used to store the internal representation of loaded classes (and much more, see here [<a href="https://plumbr.eu/blog/what-is-a-permgen-leak">1</a>] and [<a href="https://blogs.oracle.com/jonthecollector/entry/presenting_the_permanent_generation">2</a>]).</p>

<p>So, we can get <strong>OOME PermGen</strong> when ClassLoader whats to store class definition, but there is not enough space in PermGen - i.e. loaded too many classes.</p>

<p>Based on this <strong>OOME PermGen</strong> error can be generated via:</p>

<ul>
<li>decreasing PermGen size</li>
<li>loading huge amount of classes</li>
</ul>


<p>I highly recommend to read <a href="https://plumbr.eu/blog/what-is-a-permgen-leak">What is a PermGen leak?</a> post to get more info about this issue.</p>

<a name="Disclaimer"></a>
<h3>Disclaimer</h3>

<p>The current post is totally based on <a href="https://plumbr.eu/blog/how-not-to-create-a-permgen-leak">How (not) to create a permgen leak?</a></p>

<a name="Generate.PermGen.leak"></a>
<h2>Generate PermGen leak</h2>

<p>The main idea is dynamically create a lot of classes via byte code manipulation library. We are going to use <a href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/">Javassist</a> as it&rsquo;s the simplest library with nice API.</p>

<ul>
<li>We assume that it&rsquo;s <code>maven</code> based project. So, let&rsquo;s add Javassist to <code>pom.xml</code>.</li>
</ul>


<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;groupId&gt;</span>com.mycompany.app<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;artifactId&gt;</span>my-app<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>  <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;name&gt;</span>my-app<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>  <span class="nt">&lt;url&gt;</span>http://maven.apache.org<span class="nt">&lt;/url&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;properties&gt;</span>
</span><span class='line'>    <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
</span><span class='line'>    <span class="nt">&lt;skipTests&gt;</span>true<span class="nt">&lt;/skipTests&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/properties&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>      <span class="nt">&lt;groupId&gt;</span>org.javassist<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>      <span class="nt">&lt;version&gt;</span>3.15.0-GA<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/dependencies&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;build&gt;</span>
</span><span class='line'>    <span class="nt">&lt;plugins&gt;</span>
</span><span class='line'>      <span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>appassembler-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>1.9<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>        <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>          <span class="nt">&lt;extraJvmArguments&gt;</span>-XX:PermSize=2M -XX:MaxPermSize=4M<span class="nt">&lt;/extraJvmArguments&gt;</span>
</span><span class='line'>          <span class="nt">&lt;programs&gt;</span>
</span><span class='line'>            <span class="nt">&lt;program&gt;</span>
</span><span class='line'>              <span class="nt">&lt;mainClass&gt;</span>com.mycompany.app.App<span class="nt">&lt;/mainClass&gt;</span>
</span><span class='line'>              <span class="nt">&lt;id&gt;</span>app<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/program&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/programs&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/plugins&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/build&gt;</span>
</span><span class='line'><span class="nt">&lt;/project&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<ul>
<li>Also, we should set <strong>PermGen</strong> and <strong>MaxPermGen</strong> size to 2M and 4M respectively (it gives us a chance to get error as quickly as possible). Maven <code>Appassembler</code> plugin [<a href="http://mojo.codehaus.org/appassembler/appassembler-maven-plugin/usage-program-jvmsettings.html">3</a>] uses <code>extraJvmArguments</code> parameter while generating wrapper scripts: shell and batch (see <code>pom.xml</code> above, <code>&lt;extraJvmArguments&gt;-XX:PermSize=2M -XX:MaxPermSize=2M&lt;/extraJvmArguments&gt;</code>).</li>
</ul>


<blockquote><p>&ndash;XX:PermSize<size> - Set initial PermGen Size</p>

<p>&ndash;XX:MaxPermSize<size> - Set the maximum PermGen Size</p></blockquote>

<ul>
<li>Below is a simple application which dynamically creates 1000 classes to cause PermGem leak. Class creation is very simple and self explanatory. The main idea is that we should use byte code manipulation library to create classes dynamically.</li>
</ul>


<p>See additional comments in the next code snippet</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">mycompany</span><span class="o">.</span><span class="na">app</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javassist.CannotCompileException</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Steps to build and run demo application: &lt;br /&gt;</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * &lt;li&gt;mvn clean package appassembler:assemble</span>
</span><span class='line'><span class="cm"> * &lt;li&gt;target/appassembler/bin/app</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * We should use static block for OutOfMemoryError &quot;initialization&quot;</span>
</span><span class='line'><span class="cm">     * It&#39;s very important to have it. In other case JVM won&#39;t be able to</span>
</span><span class='line'><span class="cm">     * throw (actually create new OutOfMemoryError) this exception because</span>
</span><span class='line'><span class="cm">     * there will be no free memory for this. That&#39;s why we creating it beforehand.</span>
</span><span class='line'><span class="cm">     * As you can see we intentionally added output to highlight that THIS error</span>
</span><span class='line'><span class="cm">     * was produces by us.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">static</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">().</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;=====================&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Initialized/created OutOfMemoryError&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;=====================&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Start dynamic class creation.....\n&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">createClass</span><span class="o">(</span><span class="s">&quot;MyClass&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span><span class='line'>            <span class="c1">// we use this output as indicator to see the rough number of created classes</span>
</span><span class='line'>            <span class="c1">// it&#39;s not necessary to print every single (just created) class</span>
</span><span class='line'>            <span class="k">if</span><span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Class</span> <span class="nf">createClass</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CannotCompileException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ClassPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">pool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="n">className</span><span class="o">).</span><span class="na">toClass</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<ul>
<li>Run the application</li>
</ul>


<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">$</span> <span class="n">mvn</span> <span class="n">clean</span> <span class="kn">package</span> <span class="nl">appassembler:</span><span class="n">assemble</span>
</span><span class='line'><span class="n">$</span> <span class="n">target</span><span class="o">/</span><span class="n">appassembler</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">app</span>
</span><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">mycompany</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">App</span><span class="o">.&lt;</span><span class="n">clinit</span><span class="o">&gt;(</span><span class="n">App</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">15</span><span class="o">)</span>
</span><span class='line'><span class="o">=====================</span>
</span><span class='line'><span class="n">Initialized</span><span class="o">/</span><span class="n">created</span> <span class="n">OutOfMemoryError</span>
</span><span class='line'><span class="o">=====================</span>
</span><span class='line'><span class="n">Start</span> <span class="n">dynamic</span> <span class="kd">class</span> <span class="nc">creation</span><span class="o">.....</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass0</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass50</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass100</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass150</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass200</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass250</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass300</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass350</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass400</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass450</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass500</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">MyClass550</span>
</span><span class='line'><span class="n">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;Reference Handler&quot;</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span><span class="o">:</span> <span class="n">PermGen</span> <span class="n">space</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">Reference$ReferenceHandler</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">Reference</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">140</span><span class="o">)</span>
</span><span class='line'><span class="n">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;main&quot;</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span><span class="o">:</span> <span class="n">PermGen</span> <span class="n">space</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">javassist</span><span class="o">.</span><span class="na">ClassPool</span><span class="o">.</span><span class="na">toClass</span><span class="o">(</span><span class="n">ClassPool</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1089</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">javassist</span><span class="o">.</span><span class="na">ClassPool</span><span class="o">.</span><span class="na">toClass</span><span class="o">(</span><span class="n">ClassPool</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1032</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">javassist</span><span class="o">.</span><span class="na">ClassPool</span><span class="o">.</span><span class="na">toClass</span><span class="o">(</span><span class="n">ClassPool</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">990</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">javassist</span><span class="o">.</span><span class="na">CtClass</span><span class="o">.</span><span class="na">toClass</span><span class="o">(</span><span class="n">CtClass</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1125</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">mycompany</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">App</span><span class="o">.</span><span class="na">createClass</span><span class="o">(</span><span class="n">App</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">36</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">mycompany</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">App</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">App</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">29</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>The next command runs under the hood:
<code>java -XX:PermSize=2M -XX:MaxPermSize=4M -classpath "$CLASSPATH" com.mycompany.app.App</code></p>

<p>As you can see it was possible to create about 550 <code>MyClass</code> classes before we&rsquo;ve got an expected error.</p>

<a name="Tomcat.Leaks"></a>
<h3>Tomcat Leaks</h3>

<p>Tomcat team created a nice <a href="http://wiki.apache.org/tomcat/MemoryLeakProtection">wiki page</a> where listed and shown the situations where leaks can be detected and fixed.</p>

<a name="References"></a>
<h2>References</h2>

<ul>
<li><a href="https://plumbr.eu/blog/what-is-a-permgen-leak">What is a PermGen leak?</a></li>
<li><a href="https://plumbr.eu/blog/how-not-to-create-a-permgen-leak">How (not) to create a permgen leak?</a></li>
<li><a href="http://www.infoq.com/articles/Java-PERMGEN-Removed">Where Has the Java PermGen Gone?</a> PermGen is replace with Metaspace in Java 8</li>
<li><a href="https://blogs.oracle.com/jonthecollector/entry/presenting_the_permanent_generation">Presenting the Permanent Generation</a> General intro into the subject</li>
<li><a href="http://www.javaranch.com/journal/200711/creating_java_classes_runtime_expression_evaluation.html">Javassist - Creating Java classes at runtime for evaluating numerical expressions</a> Small article how to create Java classes dynamically</li>
<li><a href="http://wiki.apache.org/tomcat/MemoryLeakProtection">Tomcat Wiki MemoryLeakProtection</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Orest Ivasiv</span></span>

      




<time class='entry-date' datetime='2015-02-05T00:05:30+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:05 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/java/'>java</a>, <a class='category' href='/blog/categories/java-se/'>java se</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://halyph.com/blog/2015/02/05/how-to-generate-permgen/" data-via="halyph" data-counturl="http://halyph.com/blog/2015/02/05/how-to-generate-permgen/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/02/02/scripting-in-scala/" title="Previous Post: Scripting in Scala">&laquo; Scripting in Scala</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/02/13/do-we-need-java-for-everything/" title="Next Post: Do We Need Java for Everything?">Do We Need Java for Everything? &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p> <img class="left" src="/images/blog.jpeg">
 Orest Ivasiv <br />Software Engineer</p>
  <br />
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/09/25/programming-languages-to-native-code/">Distribute Application as Native Single Binary</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/20/grails-best-practices-collection/">Grails 2.x Best Practices Collection</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/29/devoxxpl/">DevoxxPL - Krakow, 2015 - Report</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/25/jeeconf-kiev/">JEEConf - Kiev, 2015 - Report</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/19/grails-2-dot-5-0-debug-in-intellij-idea/">Grails 2.5.0 Debug in IntelliJ IDEA</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Top Categories</h1>
    <ul id="top-category-list"><li><a href='/blog/categories/java'>java (38)</a></li><li><a href='/blog/categories/ruby'>ruby (19)</a></li><li><a href='/blog/categories/groovy'>groovy (12)</a></li><li><a href='/blog/categories/conference'>conference (11)</a></li><li><a href='/blog/categories/linux'>linux (10)</a></li><li><a href='/blog/categories/git'>git (10)</a></li><li><a href='/blog/categories/books'>books (10)</a></li><li><a href='/blog/categories/review'>review (8)</a></li><li><a href='/blog/categories/tools'>tools (6)</a></li><li><a href='/blog/categories/languages'>languages (6)</a></li></ul>
</section>
<section>
  <h1>Categories</h1>
    <span id="tag-cloud"><a href='/blog/categories/agile' style='font-size: 104.73684210526315%'>agile(3)</a> <a href='/blog/categories/annotation' style='font-size: 101.57894736842105%'>annotation(1)</a> <a href='/blog/categories/ant' style='font-size: 103.15789473684211%'>ant(2)</a> <a href='/blog/categories/architecture' style='font-size: 101.57894736842105%'>architecture(1)</a> <a href='/blog/categories/automation' style='font-size: 103.15789473684211%'>automation(2)</a> <a href='/blog/categories/barcode' style='font-size: 101.57894736842105%'>barcode(1)</a> <a href='/blog/categories/bash' style='font-size: 104.73684210526315%'>bash(3)</a> <a href='/blog/categories/blog' style='font-size: 101.57894736842105%'>blog(1)</a> <a href='/blog/categories/blogging' style='font-size: 103.15789473684211%'>blogging(2)</a> <a href='/blog/categories/books' style='font-size: 115.78947368421052%'>books(10)</a> <a href='/blog/categories/centos' style='font-size: 101.57894736842105%'>centos(1)</a> <a href='/blog/categories/certification' style='font-size: 101.57894736842105%'>certification(1)</a> <a href='/blog/categories/ci' style='font-size: 101.57894736842105%'>ci(1)</a> <a href='/blog/categories/clojure' style='font-size: 103.15789473684211%'>clojure(2)</a> <a href='/blog/categories/cmd-dot-exe' style='font-size: 101.57894736842105%'>cmd.exe(1)</a> <a href='/blog/categories/code-quality' style='font-size: 101.57894736842105%'>code quality(1)</a> <a href='/blog/categories/code-style' style='font-size: 101.57894736842105%'>code style(1)</a> <a href='/blog/categories/computation' style='font-size: 101.57894736842105%'>computation(1)</a> <a href='/blog/categories/conference' style='font-size: 117.36842105263158%'>conference(11)</a> <a href='/blog/categories/console' style='font-size: 101.57894736842105%'>console(1)</a> <a href='/blog/categories/craftsmanship' style='font-size: 103.15789473684211%'>craftsmanship(2)</a> <a href='/blog/categories/cxf' style='font-size: 104.73684210526315%'>cxf(3)</a> <a href='/blog/categories/cygwin' style='font-size: 101.57894736842105%'>cygwin(1)</a> <a href='/blog/categories/db' style='font-size: 101.57894736842105%'>db(1)</a> <a href='/blog/categories/devoxx' style='font-size: 101.57894736842105%'>devoxx(1)</a> <a href='/blog/categories/diff' style='font-size: 101.57894736842105%'>diff(1)</a> <a href='/blog/categories/eclipse' style='font-size: 103.15789473684211%'>eclipse(2)</a> <a href='/blog/categories/evernote' style='font-size: 103.15789473684211%'>evernote(2)</a> <a href='/blog/categories/general' style='font-size: 104.73684210526315%'>general(3)</a> <a href='/blog/categories/gerrit' style='font-size: 101.57894736842105%'>gerrit(1)</a> <a href='/blog/categories/gist' style='font-size: 101.57894736842105%'>gist(1)</a> <a href='/blog/categories/git' style='font-size: 115.78947368421052%'>git(10)</a> <a href='/blog/categories/github' style='font-size: 101.57894736842105%'>github(1)</a> <a href='/blog/categories/gnustep' style='font-size: 101.57894736842105%'>gnustep(1)</a> <a href='/blog/categories/golang' style='font-size: 103.15789473684211%'>golang(2)</a> <a href='/blog/categories/gradle' style='font-size: 101.57894736842105%'>gradle(1)</a> <a href='/blog/categories/grails' style='font-size: 103.15789473684211%'>grails(2)</a> <a href='/blog/categories/groovy' style='font-size: 118.94736842105263%'>groovy(12)</a> <a href='/blog/categories/h2' style='font-size: 101.57894736842105%'>h2(1)</a> <a href='/blog/categories/haskell' style='font-size: 101.57894736842105%'>haskell(1)</a> <a href='/blog/categories/hibernate' style='font-size: 101.57894736842105%'>hibernate(1)</a> <a href='/blog/categories/i18n' style='font-size: 101.57894736842105%'>i18n(1)</a> <a href='/blog/categories/intellij-idea' style='font-size: 101.57894736842105%'>intellij idea(1)</a> <a href='/blog/categories/itbooze' style='font-size: 103.15789473684211%'>itbooze(2)</a> <a href='/blog/categories/itext' style='font-size: 101.57894736842105%'>itext(1)</a> <a href='/blog/categories/ivy' style='font-size: 101.57894736842105%'>ivy(1)</a> <a href='/blog/categories/java' style='font-size: 160.0%'>java(38)</a> <a href='/blog/categories/java-se' style='font-size: 103.15789473684211%'>java se(2)</a> <a href='/blog/categories/javascript' style='font-size: 101.57894736842105%'>javascript(1)</a> <a href='/blog/categories/jax-rs' style='font-size: 104.73684210526315%'>jax-rs(3)</a> <a href='/blog/categories/jdbc' style='font-size: 101.57894736842105%'>jdbc(1)</a> <a href='/blog/categories/jdk' style='font-size: 101.57894736842105%'>jdk(1)</a> <a href='/blog/categories/jeeconf' style='font-size: 107.89473684210526%'>jeeconf(5)</a> <a href='/blog/categories/jenkins' style='font-size: 106.3157894736842%'>jenkins(4)</a> <a href='/blog/categories/jetty' style='font-size: 101.57894736842105%'>jetty(1)</a> <a href='/blog/categories/jsp' style='font-size: 101.57894736842105%'>jsp(1)</a> <a href='/blog/categories/kanban' style='font-size: 101.57894736842105%'>kanban(1)</a> <a href='/blog/categories/l10n' style='font-size: 101.57894736842105%'>l10n(1)</a> <a href='/blog/categories/languages' style='font-size: 109.47368421052632%'>languages(6)</a> <a href='/blog/categories/learning' style='font-size: 106.3157894736842%'>learning(4)</a> <a href='/blog/categories/library' style='font-size: 104.73684210526315%'>library(3)</a> <a href='/blog/categories/linux' style='font-size: 115.78947368421052%'>linux(10)</a> <a href='/blog/categories/lisp' style='font-size: 107.89473684210526%'>lisp(5)</a> <a href='/blog/categories/maven' style='font-size: 109.47368421052632%'>maven(6)</a> <a href='/blog/categories/merge' style='font-size: 101.57894736842105%'>merge(1)</a> <a href='/blog/categories/mingw' style='font-size: 101.57894736842105%'>mingw(1)</a> <a href='/blog/categories/msysgit' style='font-size: 101.57894736842105%'>msysgit(1)</a> <a href='/blog/categories/objective-c' style='font-size: 101.57894736842105%'>objective-c(1)</a> <a href='/blog/categories/ocaml' style='font-size: 101.57894736842105%'>ocaml(1)</a> <a href='/blog/categories/ocpjp' style='font-size: 101.57894736842105%'>ocpjp(1)</a> <a href='/blog/categories/octopress' style='font-size: 103.15789473684211%'>octopress(2)</a> <a href='/blog/categories/os-x' style='font-size: 107.89473684210526%'>os x(5)</a> <a href='/blog/categories/pdf' style='font-size: 104.73684210526315%'>pdf(3)</a> <a href='/blog/categories/plugin' style='font-size: 103.15789473684211%'>plugin(2)</a> <a href='/blog/categories/pomodoro' style='font-size: 103.15789473684211%'>pomodoro(2)</a> <a href='/blog/categories/productivity' style='font-size: 103.15789473684211%'>productivity(2)</a> <a href='/blog/categories/prompt' style='font-size: 103.15789473684211%'>prompt(2)</a> <a href='/blog/categories/prototyping' style='font-size: 103.15789473684211%'>prototyping(2)</a> <a href='/blog/categories/python' style='font-size: 103.15789473684211%'>python(2)</a> <a href='/blog/categories/rails' style='font-size: 109.47368421052632%'>rails(6)</a> <a href='/blog/categories/reflection' style='font-size: 101.57894736842105%'>reflection(1)</a> <a href='/blog/categories/rest' style='font-size: 104.73684210526315%'>rest(3)</a> <a href='/blog/categories/review' style='font-size: 112.63157894736842%'>review(8)</a> <a href='/blog/categories/ruby' style='font-size: 130.0%'>ruby(19)</a> <a href='/blog/categories/rust' style='font-size: 101.57894736842105%'>rust(1)</a> <a href='/blog/categories/rvm' style='font-size: 101.57894736842105%'>rvm(1)</a> <a href='/blog/categories/scala' style='font-size: 106.3157894736842%'>scala(4)</a> <a href='/blog/categories/scjp' style='font-size: 101.57894736842105%'>scjp(1)</a> <a href='/blog/categories/screencast' style='font-size: 104.73684210526315%'>screencast(3)</a> <a href='/blog/categories/scripting' style='font-size: 103.15789473684211%'>scripting(2)</a> <a href='/blog/categories/scrum' style='font-size: 101.57894736842105%'>scrum(1)</a> <a href='/blog/categories/servlet' style='font-size: 101.57894736842105%'>servlet(1)</a> <a href='/blog/categories/shell' style='font-size: 103.15789473684211%'>shell(2)</a> <a href='/blog/categories/sketching' style='font-size: 101.57894736842105%'>sketching(1)</a> <a href='/blog/categories/spring' style='font-size: 106.3157894736842%'>spring(4)</a> <a href='/blog/categories/ssh' style='font-size: 103.15789473684211%'>ssh(2)</a> <a href='/blog/categories/ssh-agent' style='font-size: 101.57894736842105%'>ssh-agent(1)</a> <a href='/blog/categories/static-analysis' style='font-size: 101.57894736842105%'>static analysis(1)</a> <a href='/blog/categories/svn' style='font-size: 101.57894736842105%'>svn(1)</a> <a href='/blog/categories/terminal' style='font-size: 103.15789473684211%'>terminal(2)</a> <a href='/blog/categories/textmate' style='font-size: 103.15789473684211%'>textmate(2)</a> <a href='/blog/categories/time-management' style='font-size: 103.15789473684211%'>time management(2)</a> <a href='/blog/categories/tomcat' style='font-size: 101.57894736842105%'>tomcat(1)</a> <a href='/blog/categories/tool' style='font-size: 101.57894736842105%'>tool(1)</a> <a href='/blog/categories/tools' style='font-size: 109.47368421052632%'>tools(6)</a> <a href='/blog/categories/top' style='font-size: 101.57894736842105%'>top(1)</a> <a href='/blog/categories/tutorial' style='font-size: 101.57894736842105%'>tutorial(1)</a> <a href='/blog/categories/tutorials' style='font-size: 101.57894736842105%'>tutorials(1)</a> <a href='/blog/categories/ui' style='font-size: 101.57894736842105%'>ui(1)</a> <a href='/blog/categories/uml' style='font-size: 101.57894736842105%'>uml(1)</a> <a href='/blog/categories/video' style='font-size: 101.57894736842105%'>video(1)</a> <a href='/blog/categories/vim' style='font-size: 103.15789473684211%'>vim(2)</a> <a href='/blog/categories/vs' style='font-size: 104.73684210526315%'>vs(3)</a> <a href='/blog/categories/windows' style='font-size: 101.57894736842105%'>windows(1)</a> <a href='/blog/categories/xp' style='font-size: 101.57894736842105%'>xp(1)</a> </span>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Orest Ivasiv -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'kie-by-halyph';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://halyph.com/blog/2015/02/05/how-to-generate-permgen/';
        var disqus_url = 'http://halyph.com/blog/2015/02/05/how-to-generate-permgen/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
